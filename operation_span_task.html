<html>
  <head>
    <title>WM operation span task</title>
    <script src="jspsych-6.0.4/jspsych.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-html-button-operationspan.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-fullscreen.js"></script>
    <script src="jspsych-6.0.4/plugins/jspsych-operation-span-recall.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <link href="jspsych-6.0.4/css/jspsych_operationspan.css" rel="stylesheet" type="text/css">
  </head>
  <body></body>
  <script>

  //----- CUSTOMIZABLE VARIABLES -----------------------------------------
  minSetSize = 4; // starting length of each trial
  maxSetSize = 7; // ending length of each trial
  repSet = 1; // number of repetitions for each set size
  randomize = true; // randomize set sizes
  file_name = null; // filename for data (will be generated if null)
  local = false; // Save data locally (set to false for server save)
  
  var possibleLetters = ["F","H","J","K","L","N","P","Q","R","S","T","V"];
  var setSizes = [];
  for (var i = minSetSize; i <= maxSetSize; i++) {
    for (var r = 1; r <= repSet; r++) {
      setSizes.push(i);
    }
  }

  // Setup the task timeline
  var nTrials = setSizes.length;
  if (randomize) {
    setSizes = jsPsych.randomization.sampleWithoutReplacement(setSizes, nTrials);
  }

  // Save data function to send to server
  function saveData(filename, filedata) {
    $.ajax({
      type: 'POST',
      url: 'save_data.php', // PHP script to save the data
      data: { filename: filename, filedata: filedata },
      success: function(response) {
        // Redirect to Qualtrics after successful save
        var qualtricsURL = "https://yourqualtricssurvey.qualtrics.com/jfe/form/SV_cwOMB3KwR2WUpKe?file_link=" + encodeURIComponent(response);
        window.location.href = qualtricsURL;
      },
      error: function() {
        alert('Error saving file.');
      }
    });
  };

  var dataLog = {
    type: 'html-keyboard-response',
    stimulus: " ",
    trial_duration: 100,
    on_finish: function(data) {
      var data = jsPsych.data.get().filter([{ trial_type: 'operation-span-recall' }, { trial_type: 'html-button-operationspan' }]);
      if (file_name == null) {
        file_name = "WM_operation_span_" + Date.now() + ".csv";
      } else {
        file_name += ".csv";
      }
      if (local) {
        data.localSave('csv', file_name);
      } else {
        saveData(file_name, data.csv());
      }
    }
  };

  var timeline = [dataLog, /* add other timeline steps here */];
  jsPsych.init({
    timeline: timeline,
    on_finish: function() {
      jsPsych.data.displayData();
    }
  });
</script>
</html>
